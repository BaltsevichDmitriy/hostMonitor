name: Home Assistant Monitor
on:
  schedule:
    - cron: '*/30 * * * *'  # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞–∂–¥—ã–µ 30 –º–∏–Ω—É—Ç
  workflow_dispatch:

jobs:
  monitor:
    runs-on: ubuntu-latest
    steps:
      - name: Check Home Assistant
        id: check
        run: |
          # –ü—Ä–æ–±—É–µ–º –ø–æ–ª—É—á–∏—Ç—å –æ—Ç–≤–µ—Ç –æ—Ç HA —Å —Ç–∞–π–º–∞—É—Ç–æ–º 10 —Å–µ–∫—É–Ω–¥
          RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" --max-time 20 http://chapay.duckdns.org:8123/ || echo "CURL_ERROR")
          
          # Home Assistant –º–æ–∂–µ—Ç –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å 401 (Unauthorized) –ø—Ä–∏ —Ä–∞–±–æ—Ç–∞—é—â–µ–º —Å–µ—Ä–≤–∏—Å–µ
          if [[ "$RESPONSE" =~ ^(200|401)$ ]]; then
            echo "result=UP" >> $GITHUB_OUTPUT
            echo "status_code=$RESPONSE" >> $GITHUB_OUTPUT
          else
            echo "result=DOWN" >> $GITHUB_OUTPUT
            echo "status_code=$RESPONSE" >> $GITHUB_OUTPUT
          fi

      - name: Send Telegram alert
        if: steps.check.outputs.result == 'DOWN'
        run: |
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_TOKEN }}/sendMessage" \
          -d "chat_id=${{ secrets.CHAT_ID }}" \
          -d "text=üö® –í–ù–ò–ú–ê–ù–ò–ï! –ü—Ä–æ–±–ª–µ–º–∞ —Å Home Assistant!%0A–ê–¥—Ä–µ—Å: http://chapay.duckdns.org:8123/%0A–ö–æ–¥ –æ—Ç–≤–µ—Ç–∞: ${{ steps.check.outputs.status_code }}%0A–í—Ä–µ–º—è: $(date '+%Y-%m-%d %H:%M:%S')%0A%0A–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–µ—Ä–≤–µ—Ä –≤—Ä—É—á–Ω—É—é." \
          -d "disable_web_page_preview=true"
